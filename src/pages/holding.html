<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <!-- <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; script-src 'unsafe-inline' https:; style-src 'unsafe-inline';">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    <title>åŸºé‡‘æŒä»“</title>
    <!-- ä½¿ç”¨CDNå¼•å…¥Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- VUE_SCRIPT_PLACEHOLDER -->
</head>

<body>
    <div id="app" v-cloak>
        <div class="header">
            <div>
                <h2>åŸºé‡‘æŒä»“</h2>
                <div class="summary">æŒä»“é‡‘é¢ã€æ”¶ç›Šå’Œä¼°å€¼ä¿¡æ¯</div>
                <div class="total-profit" :class="totalProfit >= 0 ? 'positive' : 'negative'">
                    æ€»æ”¶ç›Š: {{ totalProfit }}
                </div>
            </div>
            <div style="display: flex;">
                <div class="refresh" @click="refreshData">åˆ·æ–°</div>
                <div class="save" @click="saveData">ä¿å­˜</div>
            </div>
        </div>

        <table id="holdingTable">
            <thead>
                <tr>
                    <th>åŸºé‡‘åç§°</th>
                    <th class="text-right">å½“æ—¥æ”¶ç›Š</th>
                    <th class="text-right">æŒä»“é‡‘é¢</th>
                    <th class="text-right">å½“æ—¥æ¶¨å¹…</th>
                    <th class="text-right">æŒä»“æ¯”ä¾‹</th>
                    <!-- <th class="text-right">å½“å‰ä¼°å€¼</th> -->
                </tr>
            </thead>
            <tbody id="holdingTableBody">
                <!-- <tr v-if="loading">
                    <td colspan="5" class="text-center loading">
                        <span class="loading-spinner"></span>æ•°æ®åŠ è½½ä¸­...
                    </td>
                </tr> -->
                <tr v-for="item in holdings" :key="item.name">
                    <td>{{ item.name }}</td>
                    <td class="text-right" :class="item.dailyEarnings >= 0 ? 'positive' : 'negative'">{{
                        item.dailyEarnings }}</td>
                    <td class="text-right"> <input v-model="item.amount" @focus="focusfunc" @blur="formatAmount(item)"
                            type="number" step="0.01" maxlength="10" placeholder="è¯·è¾“å…¥"></input>
                    </td>
                    <td class="text-right" :class="item.profit >= 0 ? 'positive' : 'negative'">
                        {{ item.profit }}%
                    </td>
                    <td class="text-right">{{ item.proportion }}%</td>
                    <!-- <td class="text-right" :class="item.valuation >= 0 ? 'positive' : 'negative'">
                        {{ item.valuation >= 0 ? '+' : '' }}{{ item.valuation }}%
                    </td> -->
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        const { createApp, ref, onMounted, onBeforeMount, toRaw } = Vue;

        createApp({
            setup() {
                //acquireVsCodeApi()
                const vscode = acquireVsCodeApi();
                const loading = ref(true);
                const holdings = ref([
                    // ç¤ºä¾‹æ•°æ®
                    { name: 'åŸºé‡‘åç§°', amount: '1000.00', profit: '0.99', proportion: 25.00 }
                ]);
                // å®šä¹‰ä¸€ä¸ªæ€»æ”¶ç›Š
                const totalProfit = ref(0);
                const timer = ref(null);
                // åˆ·æ–°æ•°æ®çš„å‡½æ•°
                const refreshData = () => {
                    console.log("é¡µé¢åŠ è½½äº†ï¼");
                    vscode.postMessage({
                        command: 'positionHolding'
                    });
                    // å¯ç”¨è®¡æ—¶å™¨
                    // timersetInterval()
                    // loading.value = true;
                };

                // ä¿å­˜æ•°æ®
                const saveData = () => {
                    const rawCount = toRaw(holdings.value);
                    console.log("ä¿å­˜æ•°æ®ï¼š", rawCount);
                    vscode.postMessage({
                        command: 'saveData',
                        holdings: rawCount,
                    });
                    // setTimeout(() => {
                    //     refreshData()
                    // }, 100);
                    // åˆ¤æ–­è®¡æ—¶å™¨æ˜¯å¦å­˜ä¸å­˜åœ¨å°±è°ƒç”¨timersetInterval
                    timersetInterval()
                }


                const formatAmount = (item) => {
                    if (item.amount !== '' && item.amount !== null) {
                        // è½¬æ¢ä¸ºæµ®ç‚¹æ•°å¹¶ä¿ç•™ä¸¤ä½å°æ•°
                        const num = parseFloat(item.amount);
                        if (!isNaN(num)) {
                            item.amount = num.toFixed(2);
                        }
                    }
                };

                const timersetInterval = () => {
                    console.log("å®šæ—¶å™¨å¯åŠ¨äº†ï¼");
                    // åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯éš”10ç§’æ‰§è¡Œä¸€æ¬¡refreshDataå‡½æ•°
                    timer.value = setInterval(() => {
                        refreshData()
                    }, 10000);
                }
                const focusfunc = () => {
                    console.log("è¾“å…¥æ¡†èšç„¦äº†ï¼æ¸…æ¥šè®¡æ—¶å™¨");
                    clearInterval(timer.value)
                }

                // ç›‘å¬æ¥è‡ª VS Code çš„æ¶ˆæ¯
                window.addEventListener('message', event => {
                    console.log('æ¥æ”¶åˆ°æ¥è‡ª VS Code çš„æ¶ˆæ¯ï¼š', event.data);
                    const message = event.data;
                    switch (message.command) {
                        case 'holdingData':
                            holdings.value = message.data;
                            loading.value = false;
                            totalProfit.value = message.fundDatas.totalProfit;
                            break;
                    }
                });

                // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
                onMounted(() => {
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ åˆå§‹åŒ–é€»è¾‘
                    refreshData()
                    // å†™ä¸€ä¸ªè®¡æ—¶å™¨å®šæ—¶10sè°ƒç”¨refreshDataå‡½æ•° timer
                    timersetInterval()
                });

                onBeforeMount(() => {
                    // é”€æ¯å®šæ—¶å™¨
                    clearInterval(timer);
                });

                return {
                    loading,
                    holdings,
                    totalProfit,
                    refreshData,
                    saveData,
                    timersetInterval,
                    formatAmount,
                    focusfunc
                };
            }
        }).mount('#app');
    </script>
</body>
<style>
    [v-cloak] {
        display: none;
    }

    body {
        font-family: var(--vscode-editor-font-family, Segoe UI);
        padding: 16px;
        color: var(--vscode-foreground);
        margin: 0;
        background-color: var(--vscode-editor-background);
    }

    h2 {
        margin: 0 0 12px 0;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--vscode-editorWidget-border);
    }

    .summary {
        font-size: 0.9em;
        color: var(--vscode-descriptionForeground);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        table-layout: fixed;
        /* å›ºå®šè¡¨æ ¼å¸ƒå±€ï¼Œç¡®ä¿å¯¹é½ */
    }

    th {
        text-align: left;
        padding: 8px 12px;
        color: var(--vscode-descriptionForeground);
        font-weight: normal;
        font-size: 0.9em;
        border-bottom: 1px solid var(--vscode-editorWidget-border);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    td {
        padding: 8px 12px;
        border-bottom: 1px solid var(--vscode-editorWidget-border);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .text-right {
        text-align: right;
    }

    .text-center {
        text-align: center;
    }

    .refresh {
        cursor: pointer;
        color: var(--vscode-textLink-foreground);
        font-size: 0.9em;
        padding: 4px 8px;
        border: 1px solid transparent;
        border-radius: 4px;
        background: var(--vscode-button-background);
    }

    .refresh:hover {
        background: var(--vscode-button-hoverBackground);
    }

    .save {
        cursor: pointer;
        color: var(--vscode-textLink-foreground);
        font-size: 0.9em;
        padding: 4px 8px;
        border: 1px solid transparent;
        border-radius: 4px;
        background: greenyellow;
        margin-left: 16px;
    }

    .positive {
        color: #d73a49;
    }

    .negative {
        color: #28a745;
    }

    .loading {
        text-align: center;
        padding: 20px;
    }

    .loading-spinner::before {
        content: "ğŸ”„";
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* è®¾ç½®å„åˆ—å®½åº¦ï¼Œç¡®ä¿è¡¨å¤´å’Œå†…å®¹å¯¹é½ */
    th:nth-child(1),
    td:nth-child(1) {
        width: 30%;
    }

    /* åŸºé‡‘åç§° */
    th:nth-child(2),
    td:nth-child(2) {
        width: 20%;
    }

    /* æŒä»“é‡‘é¢ */
    th:nth-child(3),
    td:nth-child(3) {
        width: 20%;
    }

    /* å½“æ—¥æ”¶ç›Š */
    th:nth-child(4),
    td:nth-child(4) {
        width: 15%;
    }

    /* æŒä»“æ¯”ä¾‹ */
    th:nth-child(5),
    td:nth-child(5) {
        width: 15%;
    }

    .total-profit {
        margin-top: 8px;
        font-size: 1.1em;
        font-weight: bold;
    }
</style>

</html>